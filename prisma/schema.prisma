generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Modality {
  Atacado
  Varejo
}

enum CustomerType {
  PF_CPF
  PJ_CNPJ
}

enum Category {
  BOLOS
  DOCINHOS
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  IN_PRODUCTION
  READY_FOR_DELIVERY
  DELIVERED
  CANCELLED
  PRODUCTION_COMPLETE
}

enum ProductionStatus {
  PENDING
  IN_PRODUCTION
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Customer {
  id        Int          @id @default(autoincrement())
  name      String
  type      CustomerType @default(PJ_CNPJ)
  document  String       @unique
  contact   String?
  email     String?      @unique
  address   String?
  note      String?
  modality  Modality
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  orders Order[]

  @@map("customers")
  @@index([name])
  @@index([document])
  @@index([isActive])
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  fotoUrl     String?

  category      Category
  costPrice     Float   @default(0)
  markupPercent Float   @default(0)
  salePrice     Float   @default(0)
  isActive      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems     OrderItem[]
  productionTasks ProductionTask[]

  @@map("products")
  @@index([name])
  @@index([category])
  @@index([isActive])
  @@index([salePrice])
}

model Order {
  id           Int         @id @default(autoincrement())
  customerId   Int
  customer     Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  userId       Int?        @default(1)
  user         User?       @relation(fields: [userId], references: [id])

  orderDate    DateTime    @default(now())
  deliveryDate DateTime?
  status       OrderStatus @default(PENDING)
  notes        String?
  subtotal     Float?      
  discount     Float?      @default(0)
  total        Float?      @default(0)
  productionSynced Boolean @default(false)
  syncedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items           OrderItem[]
  productionTasks ProductionTask[]

  @@map("orders")
  @@index([customerId])
  @@index([status])
  @@index([deliveryDate])
  @@index([productionSynced])
  @@index([createdAt])
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int     @default(1)
  unitPrice Float
  subtotal  Float
  productionCounted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("order_items")
  @@index([orderId])
  @@index([productId])
  @@index([productionCounted])
}

model FixedExpense {
  id          Int      @id @default(autoincrement())
  description String
  value       Float
  date        DateTime @default(now())
  recurring   Boolean  @default(false)
  category    String?
  note        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fixed_expenses")
  @@index([date])
  @@index([category])
  @@index([recurring])
}

model User {
  id       Int     @id @default(autoincrement())
  name     String?
  email    String  @unique
  password String
  phone    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
  groups GroupUser[]

  @@map("users")
  @@index([email])
}

model Rule {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String

  groups RuleGroup[]

  @@map("rules")
}

model Group {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String

  rules RuleGroup[]
  users GroupUser[]

  @@map("groups")
}

model GroupUser {
  id      Int   @id @default(autoincrement())
  user    User  @relation(fields: [userId], references: [id])
  userId  Int
  group   Group @relation(fields: [groupId], references: [id])
  groupId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, groupId], name: "userId_groupId")
  @@map("group_users")
}

model RuleGroup {
  id      Int   @id @default(autoincrement())
  group   Group @relation(fields: [groupId], references: [id])
  groupId Int
  rule    Rule  @relation(fields: [ruleId], references: [id])
  ruleId  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([groupId, ruleId], name: "groupId_ruleId")
  @@map("rule_groups")
}

model ProductionTask {
  id                Int              @id @default(autoincrement())
  productId         Int
  product           Product          @relation(fields: [productId], references: [id])
  totalQuantity     Int
  pendingQuantity   Int
  completedQuantity Int              @default(0)
  status            ProductionStatus @default(PENDING)
  priority          Priority         @default(MEDIUM)
  dueDate           DateTime?
  processedOrders   Json?
  
  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("production_tasks")
  @@unique([productId])
  @@index([productId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
  @@index([createdAt])
}